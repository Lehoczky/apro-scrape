<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Apro Scraper</title>
    <link rel="stylesheet" href="index.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  </head>
  <body>
    <div class="container" id="app">
      <form class="row" @submit.prevent="startScraping($event)">
        <input
          v-model="url"
          type="url"
          placeholder="Enter HardverApro URL"
          :disabled="scraping"
          required
        />

        <div class="buttons">
          <button
            v-show="history.length"
            class="btn waves-effect waves-light"
            @click.prevent="toggleHistory()"
          >
            History
          </button>

          <button
            v-if="!scraping"
            class="btn waves-effect waves-light"
            type="submit"
          >
            Scrape
          </button>
          <button
            v-else
            class="btn waves-effect waves-light"
            @click.prevent="stopScraping()"
          >
            Stop
          </button>
        </div>
      </form>
      <div v-show="showHistory" class="row collection">
        <a
          v-for="link in history"
          class="collection-item small-font waves-effect waves-teal"
          @click="chooseHistoryLink(link)"
        >
          {{link}}
        </a>
      </div>
      <section class="row" v-for="message in messages">
        <div class="card">
          <div class="card-content">
            <span class="card-title">
              {{ dateIntervalForMessage(message) }}
            </span>
            <table class="highlight">
              <tbody>
                <tr v-for="item in message" :key="item.url">
                  <td><a :href="item.url">{{ item.title }}</a></td>
                  <td class="price">{{ item.price }}</td>
                  <td class="location">{{ item.location }}</td>
                  <td class="date">{{ item.updated }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </body>
  <script>
    const { ipcRenderer } = require("electron");

    const app = new Vue({
      el: "#app",
      data: {
        url: "",
        scraping: false,
        showHistory: false,
        history: [],
        messages: [],
      },
      created() {
        ipcRenderer.on("new-items", (event, message) => {
          this.messages.push(message);
        });

        this.history = JSON.parse(localStorage.getItem("history")) || [];
      },
      methods: {
        startScraping(event) {
          this.scraping = true;
          this.showHistory = false;
          this.addToHistory(this.url);
          ipcRenderer.send("start-scraping", this.url);
        },
        stopScraping() {
          this.scraping = false;
          ipcRenderer.send("stop-scraping");
        },
        dateIntervalForMessage(message) {
          const lastDate = message[message.length - 1].updated;
          const firstDate = message[0].updated;
          return `${lastDate} - ${firstDate}`;
        },
        toggleHistory() {
          this.showHistory = !this.showHistory;
        },
        chooseHistoryLink(link) {
          if (!this.scraping) {
            this.url = link;
          }
        },
        addToHistory(link) {
          if (this.history.includes(link)) {
            this.history.splice(this.history.indexOf(link), 1);
          }
          this.history = [link, ...this.history.slice(0, 4)];
        },
      },
      watch: {
        history(newValue, oldValue) {
          localStorage.setItem("history", JSON.stringify(newValue));
        },
      },
    });
  </script>
</html>
